<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferretería Store - Nueva Venta</title>
    <link rel="stylesheet" th:href="@{/css/form_stylesheet.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/sales-module.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i class="fas fa-tools"></i>
            <h2>Ferretería Store</h2>
        </div>

        <div class="search-box">
            <input type="text" placeholder="Search">
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a th:href="@{/home}" class="nav-link">
                    <span><i class="fas fa-chart-bar"></i> Dashboard</span>
                </a>
            </li>

            <li class="nav-item">
                <a th:href="@{/sales}" class="nav-link active">
                    <span><i class="fas fa-shopping-cart"></i> Ventas</span>
                    <i class="fas fa-chevron-down"></i>
                </a>
                <ul class="sub-menu">
                    <li><a th:href="@{/sales/form}" class="nav-link active">Nueva Venta</a></li>
                    <li><a th:href="@{/productreturns}" class="nav-link">Devoluciones</a></li>
                </ul>
            </li>

            <li class="nav-item">
                <a th:href="@{/purchases}" class="nav-link">
                    <span><i class="fas fa-truck"></i> Compras</span>
                    <i class="fas fa-chevron-down"></i>
                </a>
            </li>

            <li class="nav-item">
                <a th:href="@{/inventory}" class="nav-link">
                    <span><i class="fas fa-boxes"></i> Inventario</span>
                </a>
            </li>

            <li class="nav-item">
                <a th:href="@{/catalog}" class="nav-link">
                    <span><i class="fas fa-list"></i> Catálogo</span>
                </a>
            </li>
        </ul>

        <!-- Botón de Logout -->
        <div class="logout-section" style="margin-top: auto; padding: 20px;">
            <a th:href="@{/logout}" class="nav-link" style="color: #ef4444;">
                <span><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</span>
            </a>
        </div>
    </nav>

    <main class="form-main-container form-accent-return">
        <div class="form-header">
            <div class="form-title-section">
                <h1 class="form-title">
                    <i class="fas fa-cash-register"></i>
                    <span>Módulo de Ventas</span>
                </h1>
                <p class="form-subtitle">Sistema integrado de punto de venta - IVA 19%</p>
            </div>
            <div class="form-header-actions">
                <a th:href="@{/sales}" class="btn-pdf">
                    <i class="fas fa-arrow-left"></i>
                    Volver al listado
                </a>
            </div>
        </div>

        <div class="sales-container">
            <!-- Panel de Productos -->
            <div class="products-panel">
                <div class="form-section">
                    <div class="form-section-header">
                        <h2 class="form-section-title">
                            <i class="fas fa-search"></i>
                            Catálogo de Artículos
                        </h2>
                    </div>

                    <!-- Barra de búsqueda -->
                    <div class="search-products">
                        <div class="form-input-group">
                            <input type="text" id="productSearch" class="form-input"
                                   placeholder="Buscar por nombre, código o categoría...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>

                    <!-- Lista de artículos -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Los artículos se cargarán aquí dinámicamente -->
                        <div th:each="article : ${articles}" class="product-card"
                             th:attr="data-id=${article.idArticle},
                          data-name=${article.name},
                          data-code=${article.code},
                          data-price=${article.price},
                          data-stock=${article.quantity}">

                            <div class="product-info">
                                <h4 th:text="${article.name}">Artículo</h4>
                                <div class="product-code" th:text="'Código: ' + ${article.code}">COD001</div>
                                <span class="product-category" th:text="${article.category.name}">Categoría</span>
                            </div>

                            <div class="product-details">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <div class="product-price" th:text="'$' + ${#numbers.formatDecimal(article.price, 1, 2, 'COMMA')}">$0.00</div>
                                    <div class="product-stock"
                                         th:classappend="${article.quantity > 10 ? 'stock-good' : article.quantity > 0 ? 'stock-low' : 'stock-out'}">
                                        Stock: <span th:text="${article.quantity}">0</span>
                                    </div>
                                </div>
                                <button type="button" class="btn-add-product"
                                        th:disabled="${article.quantity == 0}" onclick="addToCart(this)">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay productos -->
                        <div th:if="${#lists.isEmpty(articles)}" class="no-products-message">
                            <i class="fas fa-box-open"></i>
                            <p>No hay artículos disponibles</p>
                            <span>Agregue productos al inventario para comenzar a vender</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Venta -->
            <div class="sale-panel">
                <form id="saleForm" th:action="@{/sales/save}" method="post" th:object="${sale}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Campo oculto para la fecha -->
                    <input type="hidden" th:field="*{date}" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" />

                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h2 class="form-section-title">
                                <i class="fas fa-user"></i>
                                Información del Cliente
                            </h2>
                        </div>

                        <div class="form-grid">
                            <div class="form-input-group">
                                <label for="client" class="form-label">
                                    <i class="fas fa-user"></i>
                                    Cliente *
                                </label>
                                <select id="client" th:field="*{client}" class="form-select" required>
                                    <option value="">Seleccione cliente</option>
                                    <option th:each="client : ${clients}"
                                            th:value="${client.idClient}"
                                            th:text="${client.name + ' - ' + client.document}">
                                    </option>
                                </select>
                            </div>

                            <div class="form-input-group">
                                <label for="employee" class="form-label">
                                    <i class="fas fa-user-tie"></i>
                                    Vendedor *
                                </label>
                                <select id="employee" th:field="*{employee}" class="form-select" required>
                                    <option value="">Seleccione empleado</option>
                                    <option th:each="employee : ${employees}"
                                            th:value="${employee.idEmployee}"
                                            th:text="${employee.name}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Carrito de Compras -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h2 class="form-section-title">
                                <i class="fas fa-shopping-cart"></i>
                                Carrito de Compras
                                <span class="cart-count" id="cartCount">(0)</span>
                            </h2>
                            <button type="button" class="btn-excel" onclick="clearCart()"
                                    title="Limpiar todo el carrito" style="font-size: 12px; padding: 5px 10px;">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>

                        <div class="cart-container" id="cartContainer">
                            <div class="empty-cart" id="emptyCart">
                                <i class="fas fa-shopping-cart"></i>
                                <p>Carrito vacío</p>
                                <span>Agregue productos desde el catálogo</span>
                            </div>

                            <div class="cart-items" id="cartItems">
                                <!-- Los items del carrito se agregarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Resumen y Total -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h2 class="form-section-title">
                                <i class="fas fa-calculator"></i>
                                Resumen de Venta
                            </h2>
                        </div>

                        <div class="sale-summary">
                            <div class="summary-row">
                                <span><i class="fas fa-coins"></i> Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span><i class="fas fa-percent"></i> IVA (19%):</span>
                                <span id="tax">$0.00</span>
                            </div>
                            <div class="summary-row total-row">
                                <span><i class="fas fa-cash-register"></i> Total a Pagar:</span>
                                <span id="total">$0.00</span>
                            </div>

                            <!-- Campo oculto para el total -->
                            <input type="hidden" th:field="*{total}" id="totalInput">
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="form-actions-container">
                        <button type="submit" class="btn-add" id="processButton" disabled>
                            <i class="fas fa-cash-register"></i>
                            Procesar Venta
                        </button>
                        <button type="button" class="btn-cancel" onclick="clearCart()">
                            <i class="fas fa-eraser"></i>
                            Limpiar Carrito
                        </button>
                        <a th:href="@{/sales}" class="btn-pdf">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </a>
                    </div>

                    <!-- Items del carrito (hidden inputs para el form submission) -->
                    <div id="cartItemsHidden" style="display: none;">
                        <!-- Los inputs ocultos se generarán aquí dinámicamente -->
                    </div>
                </form>
            </div>
        </div>

        <!-- Contenedor de notificaciones (se crea dinámicamente por JS) -->
        <div id="notificationContainer"></div>
    </main>

</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-left">
        <span>© 2025 Ferretería Store. Todos los derechos reservados.</span>
    </div>
    <div class="footer-right">
        <span>Hecho con <i class="fas fa-heart"></i> por Aprendices SENA</span>
    </div>
</footer>

<style>
    /* Estilos adicionales específicos solo si no están en el CSS principal */
    .no-products-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px 20px;
        color: var(--color-muted);
        background: var(--color-border-light);
        border-radius: 12px;
    }

    .no-products-message i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .no-products-message p {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .no-products-message span {
        font-size: 14px;
    }

    /* Mejoras para la cantidad en el carrito */
    .quantity-input {
        width: 50px;
        text-align: center;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        padding: 4px;
        font-size: 12px;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-input[type=number] {
        -moz-appearance: textfield;
    }

    /* Botón de remover item del carrito */
    .remove-item-btn {
        background: #fee2e2;
        color: #dc2626;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
    }

    .remove-item-btn:hover {
        background: #fecaca;
        transform: scale(1.1);
    }

    /* Animación de carga en botón agregar */
    .btn-add-product.loading::after {
        content: '';
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive para pantallas pequeñas */
    @media (max-width: 1200px) {
        .sales-container {
            grid-template-columns: 1fr;
        }

        .sale-panel {
            position: static;
        }
    }

    /* Estilos para asegurar que los botones se vean */
    .product-details {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }

    .btn-add-product {
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        background: #002FFF;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
        white-space: nowrap;
    }

    .btn-add-product:hover:not(:disabled) {
        background: #385CFF;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-add-product:disabled {
        background: #385CFF !important;
        color: #ffffff !important;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .btn-add-product:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    /* Asegurar que las tarjetas de producto se vean bien */
    .product-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--color-white);
        border: 2px solid var(--color-border);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.3s ease;
    }

    .product-info {
        flex: 1;
        margin-bottom: 10px;
    }

    .product-info h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--color-primary);
        line-height: 1.3;
    }

    .product-code {
        font-size: 12px;
        color: var(--color-muted);
        font-family: monospace;
        margin-bottom: 8px;
        display: block;
    }

    .product-category {
        background: var(--current-accent);
        color: white;
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
        display: inline-block;
    }

    .product-price {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent-sales, #059669);
    }

    .product-stock {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
        text-align: center;
    }

    /* Corregir para que no haya conflictos con otros estilos */
    .products-grid .btn-add-product {
        margin-top: 10px !important;
        width: 100% !important;
    }

    /* Mejoras para la cantidad en el carrito */
    .quantity-input {
        width: 50px;
        text-align: center;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        padding: 4px;
        font-size: 12px;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-input[type=number] {
        -moz-appearance: textfield;
    }

    /* Botón de remover item del carrito */
    .remove-item-btn {
        background: #fee2e2;
        color: #dc2626;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
    }

    .remove-item-btn:hover {
        background: #fecaca;
        transform: scale(1.1);
    }

    /* Animación de carga en botón agregar */
    .btn-add-product.loading::after {
        content: '';
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive para pantallas pequeñas */
    @media (max-width: 1200px) {
        .sales-container {
            grid-template-columns: 1fr;
        }

        .sale-panel {
            position: static;
        }
    }
</style>

<!-- Scripts -->
<script th:src="@{/js/sales-module.js}"></script>
</body>
</html>